<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>버디의 실내 동영상</title>

    <link rel="stylesheet" th:href="@{/css/common.css}">
    <link rel="stylesheet" th:href="@{/css/lightbox.css}">
    <link rel="stylesheet" th:href="@{/css/comments.css}">
</head>
<body>
<div class="login-area">
    <!-- 로그인 안 한 상태 -->
    <form sec:authorize="!isAuthenticated()" th:action="@{/login}" method="get">
        <button type="submit">로그인</button>
    </form>

    <!-- 로그인 한 상태 -->
    <form sec:authorize="isAuthenticated()"
          th:action="@{/logout}" method="post">
        <span sec:authentication="principal.username">user</span>
        <button type="submit">로그아웃</button>
    </form>
</div>

<header id="container">
    <h1>버디의 실내 동영상</h1>
</header>

<nav>
    <ul>
        <li><a th:href="@{/home}">홈</a></li>
        <li><a th:href="@{/photos}">사진</a></li>
        <li><a th:href="@{/videos}">동영상</a></li>
        <li><a th:href="@{/info}">정보</a></li>
    </ul>
</nav>

<!-- ✅ 기존 빨간 글씨 대신 page-title-card 사용 -->
<div class="page-title-card">
    <h2>🏠 버디의 실내 동영상</h2>
    <p>버디랑 찍은 사랑스러운 실내 동영상들을 마음껏 보세요.</p>
</div>

<div id="mediacontainer">
    <video controls>
        <source th:src="@{/videos/2024_05_15_15_37.mp4}" type="video/mp4">
        이 브라우저는 동영상 태그를 지원하지 않습니다.
    </video>
</div>

<section id="comments">
    <h3>💬 댓글</h3>

    <!-- 로그인 안 한 상태 -->
    <div sec:authorize="!isAuthenticated()">
        <p>댓글을 쓰려면 <a th:href="@{/login}">로그인</a> 해야 합니다.</p>
    </div>

    <!-- 로그인 한 상태일 때만 작성 가능 -->
    <form sec:authorize="isAuthenticated()"
          th:action="@{/comments}" method="post">
        <!-- 현재 페이지 구분 -->
        <input type="hidden" name="pageId" th:value="${pageId}">
        <textarea name="content" rows="3" required placeholder="댓글을 입력하세요..."></textarea>
        <button type="submit">댓글 작성</button>
    </form>

    <ul>
        <li th:each="comment : ${comments}">
            <strong th:text="${comment.author.name}">작성자</strong>
            <span th:text="${#temporals.format(comment.createdAt, 'yyyy-MM-dd HH:mm')}"></span>
            <p th:text="${comment.content}"></p>

            <!-- 작성자 본인 또는 관리자만 삭제 버튼 보임 -->
            <form sec:authorize="isAuthenticated() and (authentication.principal.username == ${comment.author.email} or hasRole('ADMIN'))"
                  th:action="@{'/comments/' + ${comment.id} + '/delete'}"
                  method="post">
                <input type="hidden" name="pageId" th:value="${pageId}">
                <button type="submit">삭제</button>
            </form>
        </li>
    </ul>
</section>

<footer>
    <p id="footer-year">&copy; <span id="current-year"></span> My Homepage. All rights reserved.</p>
</footer>

<script>
    // JavaScript로 년도 쉽게 업데이트하기
    document.getElementById('current-year').textContent = new Date().getFullYear();
</script>
</body>
</html>
